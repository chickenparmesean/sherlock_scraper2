(()=>{"use strict";let e=null,t=[],a=!1;function o(){if(1===figma.currentPage.selection.length){const e=figma.currentPage.selection[0];if("FRAME"===e.type)return e}const e=figma.currentPage.children.filter(e=>"FRAME"===e.type);return e.length>0?e[0]:null}async function s(e,t,a){if("TEXT"===e.type&&e.name.toLowerCase().includes(t.toLowerCase()))try{const t=e;return await figma.loadFontAsync(t.fontName),t.characters=a,!0}catch(e){console.error(`‚ùå Failed to update text "${t}":`,e)}if("children"in e)for(const o of e.children)if(await s(o,t,a))return!0;return!1}function n(e,t){if(e.name.toLowerCase().includes(t.toLowerCase()))return e;if("children"in e)for(const a of e.children){const e=n(a,t);if(e)return e}return null}async function i(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch image: ${t.status}`);const a=await t.arrayBuffer();return new Uint8Array(a)}async function r(e){try{const t=function(e){const t=e.match(/sherlock\.xyz\/watson\/([^\/\?]+)/);return t?t[1]:null}(e);if(!t)throw new Error("Invalid auditor URL. Please provide a valid Sherlock profile URL.");const a=`${await async function(){const e=["http://localhost:5000","https://localhost:5000"];for(const t of e)try{if((await fetch(`${t}/api/test`,{method:"GET",signal:AbortSignal.timeout(3e3)})).ok)return t}catch(e){}return"http://localhost:5000"}()}/api/scrape-profile`;console.log("üîç Calling scraper API:",a);const o=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,url:e})});if(!o.ok)throw new Error(`API request failed: ${o.status} ${o.statusText}`);const s=await o.json();if(!s.success)throw new Error(s.error||"Failed to scrape auditor data");return s.profile}catch(e){throw console.error("‚ùå Failed to fetch auditor data:",e),new Error(`Failed to fetch auditor data: ${e instanceof Error?e.message:"Unknown error"}`)}}console.log("üé® Auditor Slide Generator plugin loaded"),figma.showUI(__html__,{width:420,height:700,themeColors:!0}),figma.ui.onmessage=async c=>{console.log("üì© Plugin received message:",c.type);try{switch(c.type){case"generate-slide":await async function(t){if(a)figma.ui.postMessage({type:"error",message:"Generation already in progress"});else{a=!0,figma.ui.postMessage({type:"status",message:"Starting slide generation..."});try{if(!e&&(e=o(),!e))throw new Error("No template frame found. Please select a frame to use as template.");figma.ui.postMessage({type:"status",message:"Template validated. Fetching auditor data..."});const a=await r(t.auditorUrl);figma.ui.postMessage({type:"status",message:`Auditor data loaded: ${a.name}. Creating slide...`});const c=await async function(e,t,a){const o=e.clone(),s=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,16);return o.name=`${s} ${t} ${a}`,o.x=e.x+e.width+100,o.y=e.y,figma.currentPage.appendChild(o),o}(e,t.protocolName,a.name);figma.ui.postMessage({type:"status",message:"Updating text content..."}),await async function(e,t,a,o){var n,i,r,c,l,g;console.log("üìù Updating slide content...");const d=[];(null===(n=t.achievements)||void 0===n?void 0:n.highsFound)&&d.push(`${t.achievements.highsFound} highs found`),(null===(i=t.achievements)||void 0===i?void 0:i.soloHighs)&&d.push(`${t.achievements.soloHighs} solo highs found`),(null===(r=t.achievements)||void 0===r?void 0:r.mediumsFound)&&d.push(`${t.achievements.mediumsFound} mediums found`),(null===(c=t.achievements)||void 0===c?void 0:c.soloMediums)&&d.push(`${t.achievements.soloMediums} solo mediums found`);const m=d.join(", "),u=[{targetName:"auditor-name",content:t.name},{targetName:"subheading",content:a.subheading||""},{targetName:"description",content:a.description||""},{targetName:"achievement-1",content:(null===(l=t.achievements)||void 0===l?void 0:l.rankings)||""},{targetName:"achievement-2",content:(null===(g=t.achievements)||void 0===g?void 0:g.earnings)||""},{targetName:"achievement-3",content:m},{targetName:"achievement-4",content:a.achievement4||""},{targetName:"goodfit-1",content:a.goodfit1||""},{targetName:"goodfit-2",content:a.goodfit2||""},{targetName:"goodfit-3",content:a.goodfit3||""},{targetName:"title",content:`Why ${t.name} Is a Great Fit for ${o}?`},{targetName:"slide-title",content:`Why ${t.name} Is a Great Fit for ${o}?`}];let f=0;for(const t of u)t.content&&await s(e,t.targetName,t.content)&&f++;console.log(`üìù Updated ${f} text layers`)}(c,a,t.manualInputs,t.protocolName),t.selectedLogos.length>0&&(figma.ui.postMessage({type:"status",message:"Placing logos..."}),await async function(e,t,a){try{console.log(`üè¢ Placing ${t.length} logos in ${a}-logo layout`);const o=function(e,t){const a=[];return function e(t){if(t.name.toLowerCase().includes("logo")&&a.push(t),"children"in t)for(const a of t.children)e(a)}(e),a.sort((e,t)=>{const a=e,o=t;return Math.abs(a.y-o.y)<10?a.x-o.x:a.y-o.y}),a.slice(0,t)}(e,parseInt(a));if(0===o.length)return void console.log("‚ö†Ô∏è No logo containers found in template");for(let e=0;e<Math.min(t.length,o.length);e++){const a=o[e],s=t[e];try{const e=await i(s.url),t=figma.createImage(e).hash;"RECTANGLE"!==a.type&&"ELLIPSE"!==a.type||(a.fills=[{type:"IMAGE",scaleMode:"FIT",imageHash:t}]),console.log(`‚úÖ Placed logo: ${s.name}`)}catch(e){console.error(`‚ùå Failed to place logo ${s.name}:`,e)}}}catch(e){console.error("‚ùå Failed to place logos:",e)}}(c,t.selectedLogos,t.logoLayout)),a.profileImageUrl&&(figma.ui.postMessage({type:"status",message:"Replacing profile image..."}),await async function(e,t){try{console.log("üñºÔ∏è Replacing profile image...");const a=n(e,"profile");if(!a)return void console.log("‚ö†Ô∏è Profile image container not found");const o=await i(t),s=figma.createImage(o).hash;"RECTANGLE"!==a.type&&"ELLIPSE"!==a.type||(a.fills=[{type:"IMAGE",scaleMode:"FILL",imageHash:s}]),console.log("‚úÖ Profile image updated")}catch(e){console.error("‚ùå Failed to replace profile image:",e)}}(c,a.profileImageUrl)),figma.viewport.scrollAndZoomIntoView([c]),figma.currentPage.selection=[c],figma.ui.postMessage({type:"success",message:`‚úÖ Slide generated successfully for ${a.name}!`,data:{slideName:c.name,auditorData:a,logoCount:t.selectedLogos.length}})}catch(e){console.error("‚ùå Slide generation failed:",e),figma.ui.postMessage({type:"error",message:e instanceof Error?e.message:"Slide generation failed"})}finally{a=!1}}}(c.data);break;case"analyze-template":await async function(){const t=o();if(!t)return void figma.ui.postMessage({type:"error",message:"No template frame found. Please select a frame to analyze."});e=t;const a=function(e){const t=[],a=[],o=[];return function e(s){if("TEXT"===s.type)t.push({name:s.name,content:s.characters});else if("RECTANGLE"===s.type||"ELLIPSE"===s.type)if(s.name.toLowerCase().includes("logo"))o.push({name:s.name,type:s.type});else{const e=s.fills;e&&e.some(e=>"IMAGE"===e.type)&&a.push({name:s.name,type:s.type})}if("children"in s)for(const t of s.children)e(t)}(e),{frameName:e.name,textNodes:t,imageNodes:a,logoNodes:o,totalNodes:t.length+a.length+o.length}}(t);figma.ui.postMessage({type:"template-analysis",data:a})}();break;case"test-scraper":await async function(e){try{figma.ui.postMessage({type:"status",message:"Testing scraper connection..."});const t=await r(e);figma.ui.postMessage({type:"scraper-test-result",data:{success:!0,auditorData:t}})}catch(e){figma.ui.postMessage({type:"scraper-test-result",data:{success:!1,error:e instanceof Error?e.message:"Unknown error"}})}}(c.data.auditorUrl);break;case"load-logo-database":await async function(){try{const e=await figma.clientStorage.getAsync("logoDatabase");t=e||[],figma.ui.postMessage({type:"logo-database-loaded",data:t})}catch(e){console.error("Failed to load logo database:",e),figma.ui.postMessage({type:"logo-database-loaded",data:[]})}}();break;case"save-logo":await async function(e){try{t.push(e),await figma.clientStorage.setAsync("logoDatabase",t),figma.ui.postMessage({type:"logo-saved",data:e})}catch(e){figma.ui.postMessage({type:"error",message:"Failed to save logo"})}}(c.data);break;case"delete-logo":await async function(e){try{t=t.filter(t=>t.id!==e),await figma.clientStorage.setAsync("logoDatabase",t),figma.ui.postMessage({type:"logo-deleted",data:{logoId:e}})}catch(e){figma.ui.postMessage({type:"error",message:"Failed to delete logo"})}}(c.data.logoId);break;case"set-template":await async function(){const t=o();t?(e=t,figma.ui.postMessage({type:"template-set",data:{templateName:t.name}})):figma.ui.postMessage({type:"error",message:"No frame selected. Please select a frame to use as template."})}();break;default:console.log("‚ùì Unknown message type:",c.type)}}catch(e){console.error("‚ùå Plugin error:",e),figma.ui.postMessage({type:"error",message:e instanceof Error?e.message:"Unknown error occurred"})}}})();