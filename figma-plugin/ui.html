<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sherlock Auditor Slide Generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 16px;
      background: #f7f7f7;
      font-size: 13px;
      line-height: 1.4;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .header p {
      font-size: 11px;
      opacity: 0.9;
    }

    .section {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #e5e5e5;
    }

    .section h2 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    .input-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #666;
    }

    .label-required {
      color: #e74c3c;
    }

    input[type="text"], input[type="url"], textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      font-family: inherit;
      background: #fff;
      transition: border-color 0.2s;
    }

    input[type="text"]:focus, input[type="url"]:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      line-height: 1.3;
    }

    .textarea-large {
      min-height: 80px;
    }

    .field-help {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 8px;
    }

    .btn:hover {
      background: #5a6fd8;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6c757d;
      font-size: 11px;
      padding: 8px 12px;
      margin-top: 4px;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .status {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 11px;
      margin-top: 8px;
      text-align: center;
    }

    .status.loading {
      background: #e8f4f8;
      color: #2c3e50;
      border: 1px solid #bee5eb;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .analysis-result {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin-top: 8px;
      font-size: 11px;
    }

    .analysis-result h4 {
      font-size: 12px;
      margin-bottom: 6px;
      color: #495057;
    }

    .analysis-item {
      background: white;
      padding: 6px 8px;
      margin: 4px 0;
      border-radius: 3px;
      border-left: 3px solid #667eea;
    }

    .analysis-item strong {
      color: #333;
    }

    .analysis-item em {
      color: #666;
      font-size: 10px;
    }

    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .button-row .btn {
      margin-top: 0;
    }

    .examples {
      background: #e8f4f8;
      padding: 8px;
      border-radius: 4px;
      margin-top: 6px;
      font-size: 10px;
      color: #2c3e50;
    }

    .examples strong {
      color: #1a1a2e;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #eee;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üé® Auditor Slide Generator</h1>
    <p>Create professional slides with Sherlock data</p>
  </div>

  <!-- Template Analysis Section -->
  <div class="section">
    <h2>üìã Template Setup</h2>
    <p class="field-help" style="margin-bottom: 12px;">
      Select a frame to use as your slide template, then analyze its structure.
    </p>
    
    <div class="button-row">
      <button class="btn btn-secondary" onclick="analyzeTemplate()">
        Analyze Selected Frame
      </button>
      <button class="btn btn-secondary" onclick="testScraper()">
        Test Scraper
      </button>
    </div>
    
    <div id="templateAnalysis" class="hidden">
      <!-- Template analysis results will appear here -->
    </div>
  </div>

  <!-- Auditor & Protocol Section -->
  <div class="section">
    <h2>üë§ Auditor & Protocol</h2>
    
    <div class="input-group">
      <label for="auditorUrl">Auditor Profile URL <span class="label-required">*</span></label>
      <input type="url" id="auditorUrl" placeholder="https://audits.sherlock.xyz/watson/berndartmueller" />
      <div class="field-help">Paste the full Sherlock profile URL to auto-fill auditor data</div>
      <div class="examples">
        <strong>Example:</strong> https://audits.sherlock.xyz/watson/berndartmueller
      </div>
    </div>

    <div class="input-group">
      <label for="protocolName">Protocol Name <span class="label-required">*</span></label>
      <input type="text" id="protocolName" placeholder="e.g., Aave, Compound, Uniswap" />
      <div class="field-help">Used in slide title and throughout content</div>
    </div>
  </div>

  <!-- Manual Content Section -->
  <div class="section">
    <h2>‚úèÔ∏è Custom Content</h2>
    
    <div class="input-group">
      <label for="subheading">Auditor Subheading</label>
      <input type="text" id="subheading" placeholder="e.g., Security Expert, Leading DeFi Auditor" />
      <div class="field-help">Brief tagline about the auditor</div>
    </div>

    <div class="input-group">
      <label for="description">Auditor Description</label>
      <textarea id="description" class="textarea-large" placeholder="Write a comprehensive bio highlighting the auditor's expertise, background, and key achievements..."></textarea>
      <div class="field-help">Detailed description of auditor's background and expertise</div>
    </div>

    <div class="input-group">
      <label for="achievement4">Additional Achievement</label>
      <textarea id="achievement4" placeholder="e.g., Critical Bug Bounty submissions for major protocols..."></textarea>
      <div class="field-help">Fourth achievement line (1-3 are auto-filled from Sherlock)</div>
    </div>

    <div class="input-group">
      <label for="goodfit1">Why Great Fit - Point 1</label>
      <textarea id="goodfit1" placeholder="e.g., Deep expertise in yield farming protocols and governance mechanisms..."></textarea>
      <div class="field-help">First reason why this auditor is perfect for the protocol</div>
    </div>

    <div class="input-group">
      <label for="goodfit2">Why Great Fit - Point 2</label>
      <textarea id="goodfit2" placeholder="e.g., Proven track record with similar protocol architectures..."></textarea>
      <div class="field-help">Second reason why this auditor is perfect for the protocol</div>
    </div>

    <div class="input-group">
      <label for="goodfit3">Why Great Fit - Point 3</label>
      <textarea id="goodfit3" placeholder="e.g., Experience finding critical vulnerabilities in complex smart contract systems..."></textarea>
      <div class="field-help">Third reason why this auditor is perfect for the protocol</div>
    </div>
  </div>

  <!-- Generate Section -->
  <div class="section">
    <button class="btn" onclick="generateSlide()" id="generateBtn">
      üé® Generate Slide
    </button>
    
    <div id="progressContainer" class="hidden">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    
    <div id="status" class="hidden">
      <!-- Status messages will appear here -->
    </div>
  </div>

  <script>
    // UI State Management
    let isGenerating = false;

    // Analyze template structure
    function analyzeTemplate() {
      showStatus('Analyzing template structure...', 'loading');
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'analyze-template' 
        } 
      }, '*');
    }

    // Test scraper with current URL
    function testScraper() {
      const auditorUrl = document.getElementById('auditorUrl').value.trim();
      if (!auditorUrl) {
        showStatus('Please enter an auditor URL first', 'error');
        return;
      }

      showStatus('Testing scraper connection...', 'loading');
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'test-scraper',
          data: { auditorUrl }
        } 
      }, '*');
    }

    // Generate slide
    function generateSlide() {
      if (isGenerating) return;

      const auditorUrl = document.getElementById('auditorUrl').value.trim();
      const protocolName = document.getElementById('protocolName').value.trim();

      if (!auditorUrl || !protocolName) {
        showStatus('Please fill in Auditor URL and Protocol Name', 'error');
        return;
      }

      const manualInputs = {
        subheading: document.getElementById('subheading').value.trim(),
        description: document.getElementById('description').value.trim(),
        achievement4: document.getElementById('achievement4').value.trim(),
        goodfit1: document.getElementById('goodfit1').value.trim(),
        goodfit2: document.getElementById('goodfit2').value.trim(),
        goodfit3: document.getElementById('goodfit3').value.trim()
      };

      isGenerating = true;
      updateGenerateButton(true);
      showProgress(0);

      parent.postMessage({ 
        pluginMessage: { 
          type: 'generate-slide',
          data: {
            auditorUrl,
            protocolName,
            manualInputs
          }
        } 
      }, '*');
    }

    // Handle messages from plugin
    window.onmessage = (event) => {
      const { type, message, data } = event.data.pluginMessage || {};

      switch (type) {
        case 'status':
          showStatus(message, 'loading');
          updateProgress();
          break;

        case 'success':
          showStatus(message, 'success');
          updateGenerateButton(false);
          showProgress(100);
          isGenerating = false;
          break;

        case 'error':
          showStatus(message, 'error');
          updateGenerateButton(false);
          hideProgress();
          isGenerating = false;
          break;

        case 'template-analysis':
          displayTemplateAnalysis(data);
          hideStatus();
          break;

        case 'scraper-test-result':
          displayScraperTestResult(data);
          break;

        default:
          console.log('Unknown message type:', type);
      }
    };

    // Show status message
    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
      statusEl.classList.remove('hidden');
    }

    // Hide status message
    function hideStatus() {
      document.getElementById('status').classList.add('hidden');
    }

    // Update generate button state
    function updateGenerateButton(disabled) {
      const btn = document.getElementById('generateBtn');
      btn.disabled = disabled;
      btn.textContent = disabled ? 'üîÑ Generating...' : 'üé® Generate Slide';
    }

    // Show progress bar
    function showProgress(percent) {
      const container = document.getElementById('progressContainer');
      const fill = document.getElementById('progressFill');
      container.classList.remove('hidden');
      fill.style.width = `${percent}%`;
    }

    // Hide progress bar
    function hideProgress() {
      document.getElementById('progressContainer').classList.add('hidden');
    }

    // Update progress based on current step
    function updateProgress() {
      const messages = [
        'Starting slide generation...',
        'Template frame found. Fetching auditor data...',
        'Auditor data loaded',
        'Creating slide...',
        'Updating content...',
        'Replacing images...'
      ];
      
      const currentMessage = document.getElementById('status').textContent;
      const index = messages.findIndex(msg => currentMessage.includes(msg.split('.')[0]));
      const percent = index >= 0 ? ((index + 1) / messages.length) * 90 : 50;
      
      showProgress(percent);
    }

    // Display template analysis results
    function displayTemplateAnalysis(analysis) {
      const container = document.getElementById('templateAnalysis');
      
      let html = `
        <div class="analysis-result">
          <h4>üìã Template Analysis: ${analysis.frameName}</h4>
          
          <div style="margin: 8px 0;">
            <strong>üìù Text Layers (${analysis.textNodes.length} found):</strong>
            ${analysis.textNodes.slice(0, 8).map(node => `
              <div class="analysis-item">
                <strong>${node.name}</strong><br>
                <em>"${node.content.slice(0, 50)}${node.content.length > 50 ? '...' : ''}"</em>
              </div>
            `).join('')}
            ${analysis.textNodes.length > 8 ? `<div class="field-help">...and ${analysis.textNodes.length - 8} more</div>` : ''}
          </div>
          
          <div style="margin: 8px 0;">
            <strong>üñºÔ∏è Image Containers (${analysis.imageNodes.length} found):</strong>
            ${analysis.imageNodes.slice(0, 5).map(node => `
              <div class="analysis-item">
                <strong>${node.name}</strong> (${node.type})
              </div>
            `).join('')}
            ${analysis.imageNodes.length > 5 ? `<div class="field-help">...and ${analysis.imageNodes.length - 5} more</div>` : ''}
          </div>
          
          <div class="field-help" style="margin-top: 8px;">
            Total nodes: ${analysis.totalNodes}. Template ready for slide generation!
          </div>
        </div>
      `;
      
      container.innerHTML = html;
      container.classList.remove('hidden');
    }

    // Display scraper test results
    function displayScraperTestResult(result) {
      if (result.success) {
        const data = result.auditorData;
        showStatus(`‚úÖ Scraper test successful! Found: ${data.name}, ${data.achievements?.earnings || 'N/A'} earnings`, 'success');
      } else {
        showStatus(`‚ùå Scraper test failed: ${result.error}`, 'error');
      }
    }

    console.log('üé® Sherlock Auditor Slide Generator UI loaded');
  </script>
</body>
</html>